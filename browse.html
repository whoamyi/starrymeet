<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse and discover celebrities available for exclusive face-to-face meetings. Filter by category, location, and price to find your favorite stars.">

    <!-- PERFORMANCE: Font preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://starrymeet.com/browse.html">
    <meta property="og:title" content="Browse Celebrities - StarryMeet">
    <meta property="og:description" content="Browse and discover celebrities available for exclusive face-to-face meetings. Filter by category, location, and price to find your favorite stars.">
    <meta property="og:site_name" content="StarryMeet">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Browse Celebrities - StarryMeet">
    <meta name="twitter:description" content="Browse and discover celebrities available for exclusive face-to-face meetings. Filter by category, location, and price to find your favorite stars.">

    <title>Browse Celebrities - StarryMeet</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pages/browse.css">
    <script src="js/api.js"></script>
    <script src="js/shared.js"></script>
    <script src="js/browse-init-progressive.js"></script>
</head>
<body>
    <!-- Navigation - Loaded from shared component -->
    <nav role="navigation" aria-label="Main navigation" id="navbar"></nav>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Filter Sidebar - Minimalist Design -->
        <aside class="filter-sidebar" id="filterSidebar">
            <!-- Mobile Header with Drag Handle -->
            <div class="filter-header" id="filterHeader">
                <div class="filter-drag-handle"></div>
                <h3 class="filter-header-title">Filters</h3>
            </div>

            <div class="filter-content">
                <!-- Category Tree -->
                <div class="filter-group">
                    <label class="filter-label filter-label-collapsible" onclick="toggleFilterSection('categorySection')">
                        <span>Category</span>
                        <span class="filter-section-toggle" id="categoryToggle">‚ñ∏</span>
                    </label>
                    <div class="filter-tree collapsed" id="categoryTree" data-section="categorySection"></div>
                </div>

                <!-- Location Tree -->
                <div class="filter-group">
                    <label class="filter-label filter-label-collapsible" onclick="toggleFilterSection('locationSection')">
                        <span>Location</span>
                        <span class="filter-section-toggle" id="locationToggle">‚ñ∏</span>
                    </label>
                    <div class="filter-tree collapsed" id="locationTree" data-section="locationSection"></div>
                </div>

                <!-- Price Range -->
                <div class="filter-group">
                    <label class="filter-label">
                        <span>Price</span>
                        <span class="filter-value" id="priceValue">Any</span>
                    </label>
                    <input type="range"
                           min="0"
                           max="60000"
                           step="1000"
                           value="60000"
                           class="filter-slider"
                           id="priceSlider">
                    <div class="filter-range-labels">
                        <span>$0</span>
                        <span>$60K+</span>
                    </div>
                </div>

                <!-- Availability -->
                <div class="filter-group filter-group-compact">
                    <label class="filter-checkbox">
                        <input type="checkbox" id="trendingFilter">
                        <span>Trending now</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="verifiedFilter">
                        <span>Verified only</span>
                    </label>
                </div>

                <!-- Active Filters Badge -->
                <div class="active-filters" id="activeFiltersBadge" style="display: none;">
                    <span id="activeFiltersCount">0</span>
                    <button onclick="clearAllFilters()" class="clear-filters-btn">Clear all</button>
                </div>
            </div>
        </aside>

        <!-- Filter Overlay (Mobile) -->
        <div class="filter-overlay" id="filterOverlay" onclick="toggleMobileFilters()"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Expandable Search (hidden by default) -->
            <div class="expandable-search hidden" id="expandableSearch">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search by celebrity name..." id="searchInput" oninput="applyFilters()">
                </div>
            </div>

            <!-- Results Toolbar - Inline Sticky Design -->
            <div class="browse-toolbar" id="browseToolbar" data-sticky="true">
                <!-- All controls on same line -->
                <div class="toolbar-controls">
                    <!-- Search Icon -->
                    <button class="toolbar-btn toolbar-btn--search" onclick="toggleSearch()" id="searchBtn" aria-label="Toggle search">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </button>

                    <!-- Filter Icon -->
                    <button class="toolbar-btn toolbar-btn--filter" onclick="toggleFilters()" id="filterBtn" aria-label="Toggle filters">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="21" x2="4" y2="14"/>
                            <line x1="4" y1="10" x2="4" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12" y2="3"/>
                            <line x1="20" y1="21" x2="20" y2="16"/>
                            <line x1="20" y1="12" x2="20" y2="3"/>
                            <circle cx="4" cy="12" r="2"/>
                            <circle cx="12" cy="10" r="2"/>
                            <circle cx="20" cy="14" r="2"/>
                        </svg>
                    </button>

                    <!-- Grid/List Toggle -->
                    <button class="toolbar-btn toolbar-btn--view active" onclick="switchView('grid')" id="gridViewBtn" data-view="grid" aria-label="Grid view">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                    </button>

                    <button class="toolbar-btn toolbar-btn--view" onclick="switchView('list')" id="listViewBtn" data-view="list" aria-label="List view">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                    </button>

                    <!-- Sort Dropdown Display -->
                    <div class="toolbar-sort-display" onclick="document.getElementById('sortDropdown').focus()">
                        <span class="sort-label" id="sortLabel">Popular</span>
                        <svg class="sort-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        <select class="sort-dropdown-hidden" id="sortDropdown" onchange="applySorting()">
                            <option value="popular">Popular</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="availability">Availability</option>
                            <option value="name">Name (A-Z)</option>
                        </select>
                    </div>

                    <!-- Map View Button -->
                    <button class="toolbar-btn toolbar-btn--map" onclick="alert('Map view coming soon!')">
                        <span class="map-icon">üó∫Ô∏è</span>
                        <span class="map-label">Map</span>
                    </button>
                </div>

                <!-- Celebrity Count (Below toolbar) -->
                <div class="toolbar-count">
                    <p class="count-text" id="resultsCount">Showing 0 of 110 celebrities</p>
                </div>
            </div>

            <!-- Grid View -->
            <div class="celebrities-grid" id="celebritiesGrid">
                <!-- Celebrities will be loaded here -->
            </div>

            <!-- List View -->
            <div class="celebrities-list" id="celebritiesList">
                <!-- Celebrities list will be loaded here -->
            </div>

            <!-- No Results -->
            <div class="no-results hidden" id="noResults">
                <h3>No celebrities found</h3>
                <p>Try adjusting your filters or search criteria</p>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)" aria-label="Previous page">
                    ‚Üê Prev
                </button>
                <div class="pagination-numbers" id="paginationNumbers"></div>
                <button class="pagination-btn" id="nextBtn" onclick="changePage(1)" aria-label="Next page">
                    Next ‚Üí
                </button>
            </div>
        </main>
    </div>

    <script>
        // Use shared celebrity data from shared.js (will be replaced by API data)
        let celebrities = [];
        const cityByCountry = {
            "USA": ["Los Angeles", "New York", "Miami", "Atlanta", "San Francisco", "Seattle", "Chicago", "Boston", "Las Vegas", "Nashville", "Dallas", "Houston", "Phoenix", "Tampa", "Palo Alto", "Cupertino", "Mountain View", "Omaha", "Honolulu"],
            "UK": ["London"],
            "South Korea": ["Seoul", "Busan"],
            "France": ["Paris"],
            "Japan": ["Tokyo"],
            "Australia": ["Sydney"],
            "Canada": ["Vancouver", "Toronto"],
            "UAE": ["Dubai"],
            "India": ["Mumbai"],
            "Israel": ["Tel Aviv", "Jerusalem"],
            "South Africa": ["Cape Town"],
            "Kenya": ["Nairobi"],
            "Guatemala": ["Guatemala City"],
            "China": ["Hangzhou"],
            "Saudi Arabia": ["Riyadh"],
            "Spain": ["Barcelona"],
            "Jamaica": ["Kingston"],
            "Switzerland": ["Zurich"],
            "Monaco": ["Monaco"],
            "Ireland": ["Dublin"],
            "Serbia": ["Belgrade"],
            "Barbados": ["Bridgetown"],
            "Puerto Rico": ["San Juan"]
        };

        // Color palettes for celebrity initials
        const colorPalettes = [
            'linear-gradient(135deg, #667eea, #764ba2)',
            'linear-gradient(135deg, #f093fb, #f5576c)',
            'linear-gradient(135deg, #4facfe, #00f2fe)',
            'linear-gradient(135deg, #43e97b, #38f9d7)',
            'linear-gradient(135deg, #fa709a, #fee140)',
            'linear-gradient(135deg, #30cfd0, #330867)',
            'linear-gradient(135deg, #a8edea, #fed6e3)',
            'linear-gradient(135deg, #ff9a9e, #fecfef)',
            'linear-gradient(135deg, #ffecd2, #fcb69f)',
            'linear-gradient(135deg, #ff6e7f, #bfe9ff)'
        ];

        // State
        // Note: filteredCelebrities is managed by browse-init.js via window.filteredCelebrities
        let currentView = 'grid';
        let watchlist = new Set();
        let currentPage = 1;
        const perPage = 12;

        // Get initials
        function getInitials(name) {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        // Get color for celebrity
        function getColorForCelebrity(name) {
            if (!name) return colorPalettes[0];
            const index = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colorPalettes[index % colorPalettes.length];
        }

        // Update city filter based on country
        function updateCityFilter() {
            const country = document.getElementById('countryFilter').value;
            const cityFilter = document.getElementById('cityFilter');

            cityFilter.innerHTML = '<option value="">All Cities</option>';

            if (country && cityByCountry[country]) {
                cityByCountry[country].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    cityFilter.appendChild(option);
                });
            }

            applyFilters();
        }

        // Update price display
        function updatePriceDisplay() {
            const maxPrice = document.getElementById('maxPriceSlider').value;
            document.getElementById('maxPriceDisplay').textContent = '$' + parseInt(maxPrice).toLocaleString();
        }

        // Apply all filters - delegates to browse-init.js
        function applyFilters() {
            // Get search input value
            const searchInput = document.getElementById('searchInput');
            const searchQuery = searchInput ? searchInput.value.trim() : '';

            // Apply search if there's a query
            if (searchQuery && window.searchCelebrities) {
                window.searchCelebrities(searchQuery);
            } else if (window.applyAllFilters) {
                // Otherwise apply other filters
                window.applyAllFilters();
            }

            // Reset to page 1 and render
            currentPage = 1;
            renderCelebrities();
        }

        // Expose globally for inline event handlers
        window.applyFilters = applyFilters;

        // Render celebrities with pagination
        function renderCelebrities() {
            // DO NOT delegate to browse-init.js - we handle our own rendering with pagination
            if (!window.filteredCelebrities) return;

            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const paginatedCelebrities = window.filteredCelebrities.slice(start, end);

            const gridContainer = document.getElementById('celebritiesGrid');
            const listContainer = document.getElementById('celebritiesList');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');

            if (!gridContainer || !listContainer) return;

            gridContainer.innerHTML = '';
            listContainer.innerHTML = '';

            resultsCount.textContent = `Showing ${start + 1}-${Math.min(end, window.filteredCelebrities.length)} of ${window.filteredCelebrities.length} celebrities`;

            if (window.filteredCelebrities.length === 0) {
                noResults.classList.remove('hidden');
                gridContainer.classList.add('hidden');
                listContainer.classList.add('hidden');
                return;
            }

            noResults.classList.add('hidden');

            if (currentView === 'grid') {
                gridContainer.classList.remove('hidden');
                listContainer.classList.remove('active');
                paginatedCelebrities.forEach(celeb => {
                    gridContainer.innerHTML += createGridCard(celeb);
                });
            } else {
                gridContainer.classList.add('hidden');
                listContainer.classList.add('active');
                paginatedCelebrities.forEach(celeb => {
                    listContainer.innerHTML += createListCard(celeb);
                });
            }

            renderPagination();
        }

        // Expose renderCelebrities globally
        window.renderCelebrities = renderCelebrities;

        // Apply sorting
        function applySorting() {
            if (!window.filteredCelebrities) return;

            const sortDropdown = document.getElementById('sortDropdown');
            const sortLabel = document.getElementById('sortLabel');
            const sortValue = sortDropdown.value;

            // Update label text
            if (sortLabel) {
                sortLabel.textContent = sortDropdown.options[sortDropdown.selectedIndex].text;
            }

            switch(sortValue) {
                case 'price-low':
                    window.filteredCelebrities.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    window.filteredCelebrities.sort((a, b) => b.price - a.price);
                    break;
                case 'name':
                    window.filteredCelebrities.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'availability':
                    window.filteredCelebrities.sort((a, b) => a.location.localeCompare(b.location));
                    break;
                default:
                    // Popular - keep original order
                    break;
            }

            renderCelebrities();
        }

        // Toggle subcategory filter
        window.toggleSubCategoryFilter = function(childEl, mainCat, subCat) {
            event.stopPropagation(); // Prevent parent click
            childEl.classList.toggle('active');
            applyFilters();
        };

        // Toggle city filter
        window.toggleCityFilter = function(childEl, country, city) {
            event.stopPropagation(); // Prevent parent click
            childEl.classList.toggle('active');
            applyFilters();
        };

        // Clear all filters
        window.clearAllFilters = function() {
            // Clear search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';

            // Clear category tree selections
            document.querySelectorAll('#categoryTree .filter-tree-child.active').forEach(el => el.classList.remove('active'));

            // Clear location tree selections
            document.querySelectorAll('#locationTree .filter-tree-child.active').forEach(el => el.classList.remove('active'));

            // Reset price slider
            const priceSlider = document.getElementById('priceSlider');
            if (priceSlider) {
                priceSlider.value = 60000;
                document.getElementById('priceValue').textContent = 'Any';
            }

            // Clear checkboxes
            document.getElementById('trendingFilter').checked = false;
            document.getElementById('verifiedFilter').checked = false;

            // Hide active filters badge
            document.getElementById('activeFiltersBadge').style.display = 'none';

            applyFilters();
        };

        // Toggle watchlist
        window.toggleWatchlist = function(event, name) {
            event.stopPropagation();
            const btn = event.currentTarget;

            if (watchlist.has(name)) {
                watchlist.delete(name);
                btn.classList.remove('active');
                btn.innerHTML = 'ü§ç';
            } else {
                watchlist.add(name);
                btn.classList.add('active');
                btn.innerHTML = '‚ù§Ô∏è';
            }
        };

        // Switch view
        window.switchView = function(view) {
            currentView = view;
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            renderCelebrities();
        };

        // Create grid card - Social feed style with standardized height and follow button
        function createGridCard(celeb) {
            const initials = getInitials(celeb.name);
            const color = getColorForCelebrity(celeb.name);
            const slug = celeb.slug || encodeURIComponent(celeb.name.toLowerCase().replace(/\s+/g, '-'));

            // Get data
            const profession = celeb.category || 'Celebrity';
            const location = celeb.location || celeb.city || 'Virtual';
            const availableTickets = celeb.availableSlots || celeb.tickets || 0;
            const tier = celeb.tier || '';
            const rating = parseFloat(celeb.rating) || 0;
            const isFollowing = watchlist.has(celeb.name);
            const followingClass = isFollowing ? 'active' : '';
            const verifiedMark = celeb.verified ? '<svg class="card__verified" width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="11" fill="#3897f0"/><path d="M9.5 12.5L11 14L14.5 10.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '';

            // Full name for tooltip (truncated names)
            const fullName = celeb.name;

            return `
                <article class="card" onclick="window.location.href='celebrity-profile.html?slug=${encodeURIComponent(slug)}'">
                    <div class="card__media" style="background: ${color};">
                        ${celeb.imageUrl ? `<img src="${celeb.imageUrl}" alt="${celeb.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">` : `<div class="card__initials">${initials}</div>`}
                        ${tier ? `<span class="card__tier">${tier}</span>` : ''}
                        <button class="card__follow ${followingClass}" data-following="${isFollowing}" aria-pressed="${isFollowing}" onclick="event.stopPropagation(); toggleFollow('${celeb.name}', this);" title="${isFollowing ? 'Unfollow' : 'Follow'} ${celeb.name}">
                            <svg class="follow-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <line x1="19" y1="8" x2="19" y2="14"/>
                                <line x1="22" y1="11" x2="16" y2="11"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card__body">
                        <div class="card__header">
                            <h3 class="card__name" title="${fullName}">${fullName}</h3>
                            ${verifiedMark}
                        </div>
                        <p class="card__category">${profession}</p>
                        <div class="card__meta">
                            <span class="card__location">üìç ${location}</span>
                            <span class="card__divider">‚Ä¢</span>
                            <span class="card__availability">üéüÔ∏è ${availableTickets}</span>
                        </div>
                        <div class="card__stats">
                            ${rating > 0 ? `<div class="card__rating"><span class="rating-icon">‚≠ê</span><span class="rating-value">${rating.toFixed(1)}</span></div>` : '<div class="card__rating"></div>'}
                            <div class="card__price"><span class="price-value">$${(celeb.price || 0).toLocaleString()}+</span></div>
                        </div>
                    </div>
                </article>
            `;
        }

        // Toggle follow (replaces toggleWatchlist)
        window.toggleFollow = function(name, btn) {
            const isFollowing = btn.dataset.following === 'true';

            if (isFollowing) {
                watchlist.delete(name);
                btn.dataset.following = 'false';
                btn.classList.remove('active');
                btn.title = `Follow ${name}`;
            } else {
                watchlist.add(name);
                btn.dataset.following = 'true';
                btn.classList.add('active');
                btn.title = `Unfollow ${name}`;
            }
        };

        // Create list card
        function createListCard(celeb) {
            const initials = getInitials(celeb.name);
            const color = getColorForCelebrity(celeb.name);
            const isInWatchlist = watchlist.has(celeb.name);
            const heartIcon = isInWatchlist ? '‚ù§Ô∏è' : 'ü§ç';
            const watchlistClass = isInWatchlist ? 'active' : '';
            const slug = celeb.slug || encodeURIComponent(celeb.name.toLowerCase().replace(/\s+/g, '-'));

            // Profession = main category (not subcategory)
            const profession = celeb.category || 'Celebrity';

            // Location (city or meeting type)
            const location = celeb.location || celeb.city || 'Various locations';

            // Availability tickets (use üéüÔ∏è icon, not "slot")
            const availableTickets = celeb.availableSlots || celeb.tickets || 0;

            return `
                <div class="celebrity-card-list fade-in" onclick="window.location.href='celebrity-profile.html?slug=${encodeURIComponent(slug)}'" style="cursor: pointer;">
                    <div class="celebrity-image-list" style="background: ${color}">
                        ${celeb.featured ? '<div class="featured-badge">‚òÖ</div>' : ''}
                        <button class="watchlist-btn ${watchlistClass}" onclick="toggleWatchlist(event, '${celeb.name}')">${heartIcon}</button>
                        <div class="celebrity-initials">${initials}</div>
                    </div>
                    <div class="celebrity-info-list">
                        <div class="celebrity-header-list">
                            <div class="celebrity-details-list">
                                <h3 class="celebrity-name-list">${celeb.name}</h3>
                                <p class="celebrity-category">${profession}</p>
                                <div class="celebrity-meta">
                                    <span class="meta-item">üìç ${location}</span>
                                    <span class="meta-item">üéüÔ∏è ${availableTickets} available</span>
                                </div>
                            </div>
                        </div>
                        <div class="celebrity-actions-list">
                            <div class="celebrity-price-list">$${celeb.price.toLocaleString()}+</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        // Initialize dynamic filters with collapsible tree structure
        function initializeFilters() {
            // Note: buildCategoryTree and buildLocationTree are called by browse-init-progressive.js
            // after data is loaded via updateGlobalState()

            // Price slider handler
            document.getElementById('priceSlider').addEventListener('input', function() {
                const value = parseInt(this.value);
                const display = document.getElementById('priceValue');
                if (value >= 60000) {
                    display.textContent = 'Any';
                } else {
                    display.textContent = '$' + (value / 1000).toFixed(0) + 'K';
                }
            });

            document.getElementById('priceSlider').addEventListener('change', applyFilters);
            document.getElementById('trendingFilter').addEventListener('change', applyFilters);
            document.getElementById('verifiedFilter').addEventListener('change', applyFilters);
        }

        // Build category tree structure
        window.buildCategoryTree = function buildCategoryTree() {
            const categoryTree = {};

            // Use window.celebrities (loaded from API)
            const celebList = window.celebrities || [];

            console.log('üèóÔ∏è Building category tree from', celebList.length, 'celebrities');

            if (celebList.length === 0) {
                console.warn('‚ö†Ô∏è No celebrities data available to build category tree');
                return;
            }

            // Build the hierarchy
            celebList.forEach(celeb => {
                const main = celeb.category;
                const sub = celeb.subcategory;

                if (!main) return;

                if (!categoryTree[main]) {
                    categoryTree[main] = { count: 0, children: {} };
                }
                categoryTree[main].count++;

                if (sub) {
                    if (!categoryTree[main].children[sub]) {
                        categoryTree[main].children[sub] = 0;
                    }
                    categoryTree[main].children[sub]++;
                }
            });

            // Render the tree
            const container = document.getElementById('categoryTree');
            container.innerHTML = Object.entries(categoryTree)
                .sort((a, b) => b[1].count - a[1].count) // Sort by count
                .map(([mainCat, data]) => {
                    const hasChildren = Object.keys(data.children).length > 0;
                    const childrenHtml = hasChildren ? Object.entries(data.children)
                        .sort((a, b) => b[1] - a[1])
                        .map(([subCat, count]) => `
                            <div class="filter-tree-child" data-category="${mainCat}" data-subcategory="${subCat}" onclick="toggleSubCategoryFilter(this, '${mainCat}', '${subCat}')">
                                <span class="filter-tree-child-label">${subCat}</span>
                                <span class="filter-tree-child-count">${count}</span>
                            </div>
                        `).join('') : '';

                    return `
                        <div class="filter-tree-item">
                            <div class="filter-tree-parent" onclick="toggleTreeNode(this)">
                                ${hasChildren ? '<span class="filter-tree-toggle">‚ñ∏</span>' : '<span class="filter-tree-toggle" style="opacity: 0;">‚ñ∏</span>'}
                                <span class="filter-tree-label">${mainCat}</span>
                                <span class="filter-tree-count">${data.count}</span>
                            </div>
                            ${hasChildren ? `<div class="filter-tree-children">${childrenHtml}</div>` : ''}
                        </div>
                    `;
                }).join('');
        }

        // Build location tree structure
        window.buildLocationTree = function buildLocationTree() {
            const locationTree = {};

            // Use window.celebrities (loaded from API)
            const celebList = window.celebrities || [];

            console.log('üèóÔ∏è Building location tree from', celebList.length, 'celebrities');

            if (celebList.length === 0) {
                console.warn('‚ö†Ô∏è No celebrities data available to build location tree');
                return;
            }

            // Build the hierarchy
            celebList.forEach(celeb => {
                const country = celeb.country;
                const city = celeb.city;

                if (!country) return;

                if (!locationTree[country]) {
                    locationTree[country] = { count: 0, children: {} };
                }
                locationTree[country].count++;

                if (city) {
                    if (!locationTree[country].children[city]) {
                        locationTree[country].children[city] = 0;
                    }
                    locationTree[country].children[city]++;
                }
            });

            // Render the tree
            const container = document.getElementById('locationTree');
            container.innerHTML = Object.entries(locationTree)
                .sort((a, b) => b[1].count - a[1].count) // Sort by count
                .map(([country, data]) => {
                    const hasChildren = Object.keys(data.children).length > 0;
                    const childrenHtml = hasChildren ? Object.entries(data.children)
                        .sort((a, b) => b[1] - a[1])
                        .map(([city, count]) => `
                            <div class="filter-tree-child" data-country="${country}" data-city="${city}" onclick="toggleCityFilter(this, '${country}', '${city}')">
                                <span class="filter-tree-child-label">${city}</span>
                                <span class="filter-tree-child-count">${count}</span>
                            </div>
                        `).join('') : '';

                    return `
                        <div class="filter-tree-item">
                            <div class="filter-tree-parent" onclick="toggleTreeNode(this)">
                                ${hasChildren ? '<span class="filter-tree-toggle">‚ñ∏</span>' : '<span class="filter-tree-toggle" style="opacity: 0;">‚ñ∏</span>'}
                                <span class="filter-tree-label">${country}</span>
                                <span class="filter-tree-count">${data.count}</span>
                            </div>
                            ${hasChildren ? `<div class="filter-tree-children">${childrenHtml}</div>` : ''}
                        </div>
                    `;
                }).join('');
        }

        // Toggle tree node expand/collapse
        window.toggleTreeNode = function(parentEl) {
            const toggle = parentEl.querySelector('.filter-tree-toggle');
            const children = parentEl.nextElementSibling;

            if (toggle && children && children.classList.contains('filter-tree-children')) {
                toggle.classList.toggle('expanded');
                children.classList.toggle('expanded');
            }

            // DON'T apply filters on parent click - let users explore subcategories
            // Filters only apply when subcategory is clicked
        };

        // Toggle filter section collapse/expand (Category and Location)
        window.toggleFilterSection = function(sectionName) {
            const tree = document.querySelector(`[data-section="${sectionName}"]`);
            const toggle = document.getElementById(sectionName === 'categorySection' ? 'categoryToggle' : 'locationToggle');

            if (tree && toggle) {
                tree.classList.toggle('collapsed');
                tree.classList.toggle('expanded');

                // Update toggle arrow
                const isExpanded = tree.classList.contains('expanded');
                toggle.textContent = isExpanded ? '‚ñæ' : '‚ñ∏';

                // Save state to localStorage
                try {
                    const filterStates = JSON.parse(localStorage.getItem('starrymeet_filter_states') || '{}');
                    filterStates[sectionName] = isExpanded;
                    localStorage.setItem('starrymeet_filter_states', JSON.stringify(filterStates));
                } catch (e) {
                    console.warn('Could not save filter state:', e);
                }
            }
        };

        // Restore filter section states from localStorage
        window.restoreFilterStates = function() {
            try {
                const filterStates = JSON.parse(localStorage.getItem('starrymeet_filter_states') || '{}');

                // Restore category section state
                if (filterStates.hasOwnProperty('categorySection')) {
                    const categoryTree = document.querySelector('[data-section="categorySection"]');
                    const categoryToggle = document.getElementById('categoryToggle');

                    if (categoryTree && categoryToggle) {
                        if (filterStates.categorySection) {
                            categoryTree.classList.add('expanded');
                            categoryTree.classList.remove('collapsed');
                            categoryToggle.textContent = '‚ñæ';
                        } else {
                            categoryTree.classList.add('collapsed');
                            categoryTree.classList.remove('expanded');
                            categoryToggle.textContent = '‚ñ∏';
                        }
                    }
                }

                // Restore location section state
                if (filterStates.hasOwnProperty('locationSection')) {
                    const locationTree = document.querySelector('[data-section="locationSection"]');
                    const locationToggle = document.getElementById('locationToggle');

                    if (locationTree && locationToggle) {
                        if (filterStates.locationSection) {
                            locationTree.classList.add('expanded');
                            locationTree.classList.remove('collapsed');
                            locationToggle.textContent = '‚ñæ';
                        } else {
                            locationTree.classList.add('collapsed');
                            locationTree.classList.remove('expanded');
                            locationToggle.textContent = '‚ñ∏';
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not restore filter states:', e);
            }
        };

        function initializePage() {
            initializeFilters();

            // Restore saved filter section states (collapsed/expanded)
            setTimeout(() => restoreFilterStates(), 100);

            // Check for category parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');

            if (category) {
                // Find and expand the main category in the tree
                const treeItems = document.querySelectorAll('#categoryTree .filter-tree-item');
                treeItems.forEach(item => {
                    const label = item.querySelector('.filter-tree-label');
                    if (label && label.textContent.trim() === category) {
                        // This is a main category - expand it and select all children
                        const parent = item.querySelector('.filter-tree-parent');
                        const children = item.querySelector('.filter-tree-children');
                        const toggle = item.querySelector('.filter-tree-toggle');

                        if (parent && children && toggle) {
                            toggle.classList.add('expanded');
                            children.classList.add('expanded');

                            // Activate all subcategories under this main category
                            const childElements = children.querySelectorAll('.filter-tree-child');
                            childElements.forEach(child => child.classList.add('active'));
                        }
                    }
                });

                // Also check if it's a subcategory match
                const subCategoryElements = document.querySelectorAll('#categoryTree .filter-tree-child');
                subCategoryElements.forEach(el => {
                    const subCat = el.getAttribute('data-subcategory');
                    if (subCat === category) {
                        el.classList.add('active');
                        // Expand parent
                        const parent = el.closest('.filter-tree-item').querySelector('.filter-tree-parent');
                        const toggle = parent?.querySelector('.filter-tree-toggle');
                        const children = el.closest('.filter-tree-children');
                        if (toggle && children) {
                            toggle.classList.add('expanded');
                            children.classList.add('expanded');
                        }
                    }
                });
            }

            applyFilters();
        }

        // Mobile: Drag header to dismiss
        function initSwipeToDismiss() {
            const filterSidebar = document.getElementById('filterSidebar');
            const filterOverlay = document.getElementById('filterOverlay');
            const filterHeader = document.getElementById('filterHeader');
            const filterContent = filterSidebar?.querySelector('.filter-content');

            if (!filterSidebar || !filterOverlay || !filterHeader) return;

            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            // Drag from header only
            filterHeader.addEventListener('touchstart', function(e) {
                if (window.innerWidth >= 768) return;

                startY = e.touches[0].clientY;
                isDragging = true;
            }, { passive: true });

            filterHeader.addEventListener('touchmove', function(e) {
                if (!isDragging || window.innerWidth >= 768) return;

                currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                // Only allow downward swipes
                if (diff > 0) {
                    filterSidebar.style.transform = `translateY(${diff}px)`;
                }
            }, { passive: true });

            filterHeader.addEventListener('touchend', function(e) {
                if (!isDragging || window.innerWidth >= 768) return;

                const diff = currentY - startY;

                // If swiped down more than 100px, close it
                if (diff > 100) {
                    filterSidebar.classList.remove('active');
                    filterOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }

                // Reset transform
                filterSidebar.style.transform = '';
                isDragging = false;
            });

            // Prevent content scroll from dismissing
            if (filterContent) {
                filterContent.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }

            // Tap overlay to close
            filterOverlay.addEventListener('click', function() {
                if (window.innerWidth < 768) {
                    filterSidebar.classList.remove('active');
                    filterOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }

        // Toggle search expand/collapse
        window.toggleSearch = function() {
            const expandableSearch = document.getElementById('expandableSearch');
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            expandableSearch.classList.toggle('active');
            searchBtn.classList.toggle('active');

            // Focus input when opening
            if (expandableSearch.classList.contains('active')) {
                setTimeout(() => searchInput.focus(), 300);
            }
        };

        window.toggleFilterSection = function(sectionName) {
            const filterTree = document.querySelector(`[data-section="${sectionName}"]`);
            const toggleIcon = document.getElementById(sectionName.replace('Section', 'Toggle'));

            if (filterTree) {
                filterTree.classList.toggle('collapsed');
                if (toggleIcon) {
                    toggleIcon.classList.toggle('expanded');
                }
            }
        };

        // Close search when clicking outside
        document.addEventListener('click', function(e) {
            const expandableSearch = document.getElementById('expandableSearch');
            const searchBtn = document.getElementById('searchBtn');

            if (expandableSearch.classList.contains('active') &&
                !expandableSearch.contains(e.target) &&
                !searchBtn.contains(e.target)) {
                expandableSearch.classList.remove('active');
                searchBtn.classList.remove('active');
            }
        });

        // Close search on Enter key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'Escape') {
                const expandableSearch = document.getElementById('expandableSearch');
                const searchBtn = document.getElementById('searchBtn');
                if (expandableSearch.classList.contains('active')) {
                    expandableSearch.classList.remove('active');
                    searchBtn.classList.remove('active');
                }
            }
        });

        // Toolbar becomes sticky when hero scrolls out of view
        function initToolbarScroll() {
            const toolbar = document.getElementById('resultsToolbar');
            const hero = document.getElementById('heroSection');

            if (!toolbar || !hero) {
                console.error('‚ùå Toolbar or Hero not found!', { toolbar, hero });
                return;
            }

            console.log('‚úÖ Toolbar sticky initialized');

            window.addEventListener('scroll', function() {
                const heroRect = hero.getBoundingClientRect();
                const navHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 80;

                // When hero's bottom reaches the navbar (scrolled out of view)
                if (heroRect.bottom <= navHeight) {
                    if (!toolbar.classList.contains('sticky')) {
                        toolbar.classList.add('sticky');
                        console.log('üîí Toolbar is now sticky');
                    }
                } else {
                    if (toolbar.classList.contains('sticky')) {
                        toolbar.classList.remove('sticky');
                        console.log('üîì Toolbar is no longer sticky');
                    }
                }
            }, { passive: true });
        }

        // Wait for DOM to be ready before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializePage();
                initSwipeToDismiss();
                initToolbarScroll();
            });
        } else {
            initializePage();
            initSwipeToDismiss();
            initToolbarScroll();
        }

        // Toggle filters (only works on mobile, desktop filters always visible)
        window.toggleFilters = function() {
            // Check if we're on mobile (window width < 768px)
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                const sidebar = document.getElementById('filterSidebar');
                const overlay = document.getElementById('filterOverlay');
                const wasActive = sidebar.classList.contains('active');

                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');

                // Prevent body scroll when filters open on mobile
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';

                // Auto-apply filters when closing
                if (wasActive) {
                    applyFilters();
                }
            }
            // On desktop, do nothing - filters are always visible
        };

        // Note: toggleFilterSection is defined earlier in the file (around line 742)
        // Don't redefine it here to avoid conflicts

        // Show more items in filter section
        window.toggleShowMore = function(sectionId) {
            const section = document.getElementById(sectionId);
            const hiddenItems = section.querySelectorAll('.hidden-initially');
            const button = section.querySelector('.show-more-btn');

            const isExpanded = hiddenItems[0].style.display !== 'none' && hiddenItems[0].style.display !== '';

            hiddenItems.forEach(item => {
                item.style.display = isExpanded ? 'none' : 'flex';
            });

            button.textContent = isExpanded ? 'Show more' : 'Show less';
        };

        // Render filter chips
        function renderFilterChips() {
            const chipsContainer = document.getElementById('filterChips');
            const chips = [];

            const selectedCategories = Array.from(document.querySelectorAll('.checkbox-item input:checked'));
            selectedCategories.forEach(cb => {
                chips.push(`<div class="filter-chip">${cb.value}<button onclick="removeFilterChip('category', '${cb.value}')">√ó</button></div>`);
            });

            const selectedCountry = document.getElementById('countryFilter').value;
            if (selectedCountry) {
                chips.push(`<div class="filter-chip">${selectedCountry}<button onclick="removeFilterChip('country', '${selectedCountry}')">√ó</button></div>`);
            }

            const selectedCity = document.getElementById('cityFilter').value;
            if (selectedCity) {
                chips.push(`<div class="filter-chip">${selectedCity}<button onclick="removeFilterChip('city', '${selectedCity}')">√ó</button></div>`);
            }

            const maxPrice = parseInt(document.getElementById('maxPriceSlider').value);
            if (maxPrice < 60000) {
                chips.push(`<div class="filter-chip">Up to $${maxPrice}<button onclick="removeFilterChip('price', '${maxPrice}')">√ó</button></div>`);
            }

            const trending = document.getElementById('trendingToggle').checked;
            if (trending) {
                chips.push(`<div class="filter-chip">Trending<button onclick="removeFilterChip('trending', '')">√ó</button></div>`);
            }

            chipsContainer.innerHTML = chips.join('');
            chipsContainer.style.display = chips.length > 0 ? 'flex' : 'none';
        }

        // Remove filter chip
        window.removeFilterChip = function(type, value) {
            if (type === 'category') {
                const checkbox = Array.from(document.querySelectorAll('.checkbox-item input')).find(cb => cb.value === value);
                if (checkbox) checkbox.checked = false;
            } else if (type === 'country') {
                document.getElementById('countryFilter').value = '';
                document.getElementById('cityFilter').value = '';
            } else if (type === 'city') {
                document.getElementById('cityFilter').value = '';
            } else if (type === 'price') {
                document.getElementById('maxPriceSlider').value = '60000';
            } else if (type === 'trending') {
                document.getElementById('trendingToggle').checked = false;
            }
            applyFilters();
        };

        // Pagination functions
        window.changePage = function(delta) {
            if (!window.filteredCelebrities) return;
            const totalPages = Math.ceil(window.filteredCelebrities.length / perPage);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            renderCelebrities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.goToPage = function(page) {
            currentPage = page;
            renderCelebrities();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderPagination() {
            if (!window.filteredCelebrities) return;
            const totalPages = Math.ceil(window.filteredCelebrities.length / perPage);
            const pagination = document.getElementById('pagination');
            const numbersContainer = document.getElementById('paginationNumbers');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            // Build page numbers
            let pages = [];

            // Always show first page
            pages.push(1);

            // Show current ¬± 2 pages
            for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
                if (i > 1 && i < totalPages) {
                    pages.push(i);
                }
            }

            // Always show last page
            if (totalPages > 1) {
                pages.push(totalPages);
            }

            // Remove duplicates and sort
            pages = [...new Set(pages)].sort((a, b) => a - b);

            // Build HTML with ellipsis
            numbersContainer.innerHTML = pages.map((page, index) => {
                const prevPage = pages[index - 1];
                const gap = prevPage && page - prevPage > 1 ? '<span class="pagination-ellipsis">...</span>' : '';
                const active = page === currentPage ? 'active' : '';
                return `${gap}<button class="pagination-num ${active}" onclick="goToPage(${page})">${page}</button>`;
            }).join('');
        }

        // Initialize: Collapse all filter sections on page load
        document.addEventListener('DOMContentLoaded', function() {
            // All collapsible sections start collapsed
            const collapsibles = document.querySelectorAll('.checkbox-group.collapsible');
            collapsibles.forEach(section => {
                section.classList.remove('expanded');
            });

            // All toggle buttons start not expanded
            const toggles = document.querySelectorAll('.filter-section-toggle');
            toggles.forEach(toggle => {
                toggle.classList.remove('expanded');
            });
        });

        // Alias for mobile overlay
        window.toggleMobileFilters = window.toggleFilters;

    </script>

    <!-- Footer - Loaded from shared component -->
    <footer class="footer"></footer>

    <!-- Inject shared components -->
    <script src="js/inject-layout.js"></script>
</body>
</html>
